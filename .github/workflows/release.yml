name: Release Packaging

on:
  push:
    tags:
      - "v*"

  workflow_dispatch:

jobs:
  package:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    runs-on: ${{ matrix.os }}

    env:
      BUILD_TYPE: Release

    steps:
      - uses: actions/checkout@v4

      # -----------------------------------------
      # Create source zip
      # -----------------------------------------
      - name: Create source zip
        if: startsWith(matrix.os, 'ubuntu') && startsWith(github.ref, 'refs/tags/')
        run: |
          git archive --format=zip --output Mellodica-${{ github.ref_name }}-src.zip HEAD
      
      # -----------------------------------------
      # Upload as release asset
      # -----------------------------------------
      - name: Upload source zip to release
        uses: softprops/action-gh-release@v2
        if: startsWith(matrix.os, 'ubuntu') && startsWith(github.ref, 'refs/tags/')
        with:
          files: Mellodica-${{ github.ref_name }}-src.zip

      ###############################################################
      # LINUX — build deps
      ###############################################################
      - name: Install dependencies (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo apt update
          sudo apt install -y \
            g++ clang cmake ninja-build \
            libsdl2-dev libsdl2-image-dev libsdl2-ttf-dev \
            libfluidsynth-dev libglew-dev libgl1-mesa-dev \
            patchelf desktop-file-utils file

      ###############################################################
      # MACOS — build deps
      ###############################################################
      - name: Install dependencies (macOS)
        if: startsWith(matrix.os, 'macos')
        run: |
          brew update
          brew install \
            cmake glib jack sdl2 sdl2_image sdl2_ttf \
            glew libsndfile pkg-config gettext dylibbundler

          # Build fluidsynth (same as your main workflow)
          curl -L -o fluidsynth.tar.gz \
            https://github.com/FluidSynth/fluidsynth/archive/refs/tags/v2.4.8.tar.gz
          tar xf fluidsynth.tar.gz
          mv fluidsynth-2.4.8 fluidsynth
          cd fluidsynth
          mkdir build && cd build
          cmake .. \
            -Denable-sdl2=1 \
            -Denable-framework=0 \
            -Denable-floats=1 \
            -Denable-libsndfile=1 \
            -Denable-gentables=0 \
            -DCMAKE_INSTALL_PREFIX=/usr/local
          make -j$(sysctl -n hw.logicalcpu)
          sudo make install
          sudo update_dyld_shared_cache

      ###############################################################
      # Configure + build + package using CPack
      ###############################################################
      - name: Configure CMake
        run: |
          cmake -S . -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=$BUILD_TYPE \

      - name: Build
        run: cmake --build build --config $BUILD_TYPE -j

      - name: Package
        run: cmake --build build --target package

      ###############################################################
      # AppImage (manual)
      ###############################################################

      - name: Install AppImage tools (linuxdeploy)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-appimage/releases/download/continuous/linuxdeploy-plugin-appimage-x86_64.AppImage
          chmod +x linuxdeploy*.AppImage

      - name: Prepare AppDir structure
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/64x64/apps

          # Install your executable into AppDir
          cp build/mellodica AppDir/usr/bin/

          # Desktop entry
          cp assets/mellodica.desktop AppDir/usr/share/applications/mellodica.desktop

          # Icon
          cp assets/mellodica.png AppDir/usr/share/icons/hicolor/64x64/apps/mellodica.png

          # Copy all assets used by game
          cp -r assets AppDir/usr/bin/

      - name: Generate AppImage
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          export PATH=$PATH:$PWD  # so linuxdeploy sees the plugin
          ./linuxdeploy-x86_64.AppImage \
              --appdir AppDir \
              --desktop-file=AppDir/usr/share/applications/mellodica.desktop \
              --icon-file=AppDir/usr/share/icons/hicolor/64x64/apps/mellodica.png \
              --output appimage

     

      ###############################################################
      # Upload Linux AppImage
      ###############################################################
      - name: Upload AppImage
        if: startsWith(matrix.os, 'ubuntu')
        uses: actions/upload-artifact@v4
        with:
          name: Mellodica-AppImage
          path: "./Mellodica-x86_64.AppImage"
      
      
      ###############################################################
      # Upload macOS DMG
      ###############################################################
      - name: Upload DMG
        if: startsWith(matrix.os, 'macos')
        uses: actions/upload-artifact@v4
        with:
          name: Mellodica-DMG
          path: "/Users/runner/work/Mellodica/Mellodica/build/Mellodica-Darwin.dmg"


      ###############################################################
      # Upload assets to GitHub Release
      ###############################################################
      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            ${{ startsWith(matrix.os, 'ubuntu') && './Mellodica-x86_64.AppImage' || '' }}
            ${{ startsWith(matrix.os, 'macos')  && '/Users/runner/work/Mellodica/Mellodica/build/Mellodica-Darwin.dmg' || '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}



